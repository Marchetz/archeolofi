<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <title></title>
        <link rel="stylesheet" type="text/css" href="libs/jquery.mobile-1.4.2/jquery.mobile-1.4.2.css">
        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
        <link rel="stylesheet" type="text/css" href="style.css" />
        <script src="libs/jquery-1.11.1.min.js"></script>
	    <script src="libs/jquery.mobile-1.4.2/jquery.mobile-1.4.2.js"></script>
        <script type="text/javascript" src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
        
        <script src="functions.js"></script>

        <script>
            
           
            
            
            $(document).ready( function() {
                $("#bottone_login").click( function() {
                    data = read_form("login");
                    if(!data)
                        return;
                    login(data[0], data[1]);
                });
            });
            
            $(document).ready( function() {
                $("#bottone_register").click( function() {
                    data = read_form("register");
                    if(!data)
                        return;
                    register(data[0], data[1], data[2]);
                });
            });
        
        
        
        
        </script>
        
        
        <!-- <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; minimum-scale=1.0; user-scalable=no; target-densityDpi=device-dpi" /> -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    </head>
    <body>
        
        <div data-role="page" id="home"  >
            
            <div data-role="header" data-position="inline">
                <h1>Pagina principale</h1>
                <a href="#login" data-role="button" class="ui-btn-right" >Login</a>
            </div>
            
            <div data-role="content" >
               <div id="map" class="map" ></div>
                
                <script>
                    
                    
                    ///////////////////////// INSERIMENTO DELLA MAPPA ////////////////////////////
                    var map = L.map('map')

                    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
                                maxZoom: 25
                    }).addTo(map);
                    
                   
                    map.locate({setView: true, maxZoom: 16});
                    
                    function onLocationFound(e) {
                        var radius = e.accuracy / 2;

                        L.circle(e.latlng, radius).addTo(map).bindPopup("You are within " + radius + " meters from this point").openPopup();
                        console.log(e);
                    }
                    
                    
                    map.on('locationfound', onLocationFound);
                    
                    function onLocationError(e) {
                        alert(e.message);
                    }

                    map.on('locationerror', onLocationError);
                    
                 
                     
                    ///////////////////// INSERIMENTO LAYER WMS SCAVI ARCHEOLOGICI ///////////////////
                    
                        
                    var datilayer1 = L.tileLayer.wms('http://datigis.comune.fi.it/geoserver/wms?', {
                                    layers: 'archeologia:scavi_archeo',
                                    format: 'image/png',
                                    transparent: true,
                                    attribution: ""
                                });
                        
                        
                    datilayer1.addTo(map);
                        
                    ////////////// GESTIONE POPUP INFORMAZIONI TRAMITE CLICK SU MAPPA   /////////
                        
                        
                    map.addEventListener('click', onMapClick);
                        
                    popup = new L.Popup({ width: 50 });
                    
                    
                    function onMapClick(e) {
                        
                        var latlngStr = '(' + e.latlng.lat.toFixed(3) + ' , ' + e.latlng.lng.toFixed(3) + ')';
                        var BBOX = map.getBounds()._southWest.lat+","+map.getBounds()._southWest.lng+","+map.getBounds()._northEast.lat+","+map.getBounds()._northEast.lng; // coordinate server ( long, lat ) coordinate standard ( lat, long)
                        //console.log(BBOX);
                        var WIDTH = map.getSize().x;
                        var HEIGHT = map.getSize().y;
                        var X = map.layerPointToContainerPoint(e.layerPoint).x;
                        var Y = map.layerPointToContainerPoint(e.layerPoint).y;
                        var URL = 'http://datigis.comune.fi.it/geoserver/wms?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&BBOX='+BBOX+' &CRS=EPSG:4326&WIDTH='+WIDTH+'&HEIGHT='+HEIGHT+'&LAYERS=archeologia:scavi_archeo&STYLES=&FORMAT=image/png&QUERY_LAYERS=archeologia:scavi_archeo&INFO_FORMAT=text/plain&I='+X+'&J='+Y+'&FEATURE_COUNT=10';
                        ////////////// APERTURA POPUP E GESTIONE INFO  /////////
                        wms_proxy(BBOX, WIDTH, HEIGHT, X, Y, e);
                        
                        };
                            
                    
                    </script>
                </div>    
        </div>
        
        
        
       <!-- ----------------------------- INFO -------------------------------------- -->

        
        
        
        
        <div data-role="page" id="info">
            <div data-role="header" >
                <h1>Info</h1>
                <a href="#home">Map</a>
            </div>

            
            <div data role="content">
                
                <div data-role="collapsible-set">
                    <div data-role="collapsible" data-collapsed="false">
                        <h3>informazioni meta-data</h3>
                        <p><script>
                            
                            document.write(storeObject.firstname);
                            //document.write("<iframe src='"+dato+"' frameborder='0'></iframe>");
                            
                            
                            </script>
                            
                            
                        </p>
                    </div>
                    
                    <div data-role="collapsible" >
                        <h3>informazioni prese dal sito</h3>
                        <p>info archeologiche del sito</p>
                    </div>
                    
                    <div data-role="collapsible" >
                        <h3>commenti utenti</h3>
                        <p>puoi scrivere un tuo commento e mettere una foto</p>
                    </div>
                </div>
            
            
            </div>
            
        
        </div>
        
    <!-- ----------------------------- LOGIN & REGISTER -------------------------------------- -->
        <div data-role="page" id="login">
            <div data-role="header" >
                <a href="#home">Map</a>
                <h2>Login</h2>
            </div>
            <div data-role="content">
                <form name= "login" >
                    <div data-role="fieldcontain" class="ui-hide-label">
                        <label for="username">Username:</label>
                        <input type="text" name="name" id="name" value="" placeholder="Username" required/>
                    </div>

                    <div data-role="fieldcontain" class="ui-hide-label">
                        <label for="password">Password:</label>
                        <input type="password" name="psw" id="psw" value="" placeholder="Password" required/>
                    </div>

                    <input type="button" id="bottone_login" data-icon="check" value="Login">    
                
                    <div data-role="collapsible" data-collapsed="true" data-theme="a" id="registration">
                        <h3>Se non sei ancora registrato inserisci anche la tua e-mail</h3>

                        <div data-role="fieldcontain" class="ui-hide-label">
                            <label for="e-mail">E-mail:</label>
                            <input type="text" name="email" id="email" value="" placeholder="e-mail" />
                        </div>
                        
                        <input type="button" id="bottone_register" data-icon="edit" value="Register">
                    </div>
                </form>

            </div>
            
        
        </div>

        
        <div class="popups" id="popup_ritrovamento">
            <h3 class="pop_elem"><!-- definizione --></h3>
            <p class="pop_elem"><!-- descrizione_min --></p>
            <span id="periodo" class="pop_elem ritr"></span>
            <span id="tipologia_ritrov" class="pop_elem ritr"></span>
        </div>
        <div class="popups" id="popup_intervento">
            <h3 class="pop_elem"><!-- tipo_intervento --></h3>
            <time id="data_compilazione" class="pop_elem"></time>
            <ul class="pop_elem">
                <li>
                    metodo: <span id="metodo" class="pop_elem inte"></span>
                </li>
                <li>
                    direzione scientifica: <span id="dir_scentifica" class="pop_elem inte"></span>
                </li>
                <li>
                    ente responsabile: <span id="ente_resp" class="pop_elem inte"></span>
                </li>
                <li>
                    ente schedatore: <span id="ente_schedatore" class="pop_elem inte"></span>
                </li>
                <li>
                    esecutore intervento: <span id="esecutore_intervento" class="pop_elem inte"></span>
                </li>
                <li>
                    tipo particella: <span id="tipo_particella" class="pop_elem inte"></span>
                </li>
            </ul>
        </div>
    </body>
</html>
